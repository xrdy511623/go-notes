
---
CPU性能优化的思路
---

# 1 如何评估性能优化的效果？

## 1.1 确定性能的量化指标

我们应该至少从应用程序和系统资源两个维度，分别选择不同的指标。比如，以Web应用为例:
应用程序的维度，我们可以用吞吐量和请求延迟来评估应用程序的性能。
系统资源的维度，我们可以用CPU使用率来评估系统的CPU使用情况。

以Web应用为例，我们可以选择ab等工具，测试Web应用的并发请求数和响应延迟。测试的同时，还可以用vmstat、pidstat等性能
工具观察系统和进程的CPU使用率。如此，我们便获得了应用程序和系统资源这两个维度的指标数据。

## 1.2 测试优化前的性能指标
## 1.3 测试优化后的性能指标

在进行性能测试时，有两个特别重要的地方需要注意:
第一，要避免性能测试工具干扰应用程序的性能。也就是说，性能测试工具和目标应用程序要在不同的机器上运行。
第二，要避免外部环境的变化影响性能指标的评估。这要求优化前、后的应用程序，都运行在相同配置的机器上，
并且它们的外部依赖也要完全一致。


## 1.4 如果有多个性能问题同时存在，要怎么选择？
可以把所有性能问题都给分析一遍，找出最重要的，可以最大限度提升性能的问题，从它开始优化。

如果剩下的问题还有好几个，那就得分别进行性能测试了。比较不同的优化效果后，选择能明显提升性能的那个问题进行修复。
这个过程通常会花费较多的时间，这里有两个可以简化这个过程的方法。

第一，如果发现是系统资源达到了瓶颈，比如CPU使用率达到了100%，那么首先优化的一定是系统资源使用问题。完成系统资源瓶颈的优化后，
我们才会考虑其他问题。
第二，针对不同类型的指标，要首先去优化那些由瓶颈导致的，性能指标变化幅度最大的问题。比如产生瓶颈后，用户CPU使用率升高了10%，
而系统CPU使用率却升高了50%，这个时候就应该首先优化系统CPU的使用。

# 2 CPU优化

## 2.1 应用程序优化
首先，从应用程序的角度来说，降低CPU使用率的最好方法当然是，排除所有不必要的工作，只保留最核心的逻辑。比如减少循环的层次、
减少递归、减少动态内存分配等等。

除此之外，还有以下几种常见的思路：

编译器优化：很多编译器都会提供优化选项，适当开启它们，在编译阶段就可以获得编译器的帮助，来提升性能。比如，gcc就提供了优化选项
-O2，开启后会自动对应用程序的代码进行优化。

算法优化: 使用复杂度更低的算法，可以显著加快处理速度。

异步处理: 使用异步处理，可以避免程序因为等待某个资源而一直阻塞，从而提升程序的并发处理能力。比如，将轮询替换为事件通知，
就可以避免轮询耗费CPU的问题。

多线程代替多进程: 相对于进程的上下文切换，线程的上下文切换并不会切换进程的地址空间，因此可以降低上下文切换的成本。

善用缓存: 经常访问的数据或者计算过程中的步骤，可以放到内存中缓存起来，这样下次使用就可以直接从内存中获取，加快程序的处理速度。

## 2.2 系统优化

从系统的角度来说，优化CPU的运行，一方面要充分利用CPU缓存的本地特性，加速缓存访问；另一方面，就是要控制进程的CPU使用情况，减少进程间的相互影响。

具体来说，系统层面的CPU优化方法也有不少，常见的有：

CPU绑定: 把进程绑定到一个或多个CPU上，可以提高CPU缓存的命中率，减少跨CPU调度带来的上下文切换问题。

CPU独占: 与CPU绑定类似，进一步将CPU分组，并通过CPU亲和性机制为其分配进程。这样，这些CPU就由指定的进程独占，换句话说，
不允许其他进程再来使用这些CPU。

优先级调整: 使用nice调整进程的优先级，正值调低优先级，负值调高优先级。我们可以适当降低非核心应用的优先级，提高核心应用
的优先级，可以确保核心应用得到优先处理。

为进程设置资源限制: 使用Linux cgroups来设置进程的CPU使用上限，可以防止由于某个应用自身的问题，而耗尽系统资源。

NUMA(非统一内存访问)优化: 支持NUMA的处理器会被划分为多个node，每个node都有自己的本地内存空间。NUMA优化，其实就是
让CPU尽可能只访问本地内存。

中断负载均衡: 无论是软中断还是硬中断，它们的中断处理程序都可能会耗费大量的CPU。开启irqbalance服务或者配置smp_affinity，
就可以把中断处理过程自动负载到多个CPU上。


# 3 千万避免过早优化

一定要牢记，过早优化是万恶之源。

因为，一方面，优化会带来复杂性的提升，降低可维护性；另一方面，需求不是一成不变的。针对当前情况进行的优化，很可能并不适应
快速变化的新需求。这样，在新需求出现时，这些复杂的优化，反而可能阻碍新功能的开发。

所以，性能优化最好是逐步完善，动态进行，不追求一步到位，而要首先保证能满足当前的性能请求，当发现性能不满足要求或者出现性能
瓶颈时，再根据性能评估的结果，选择最重要的性能问题进行优化。

