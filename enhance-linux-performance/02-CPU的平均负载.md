
---
CPU的平均负载
---

# 1 如何理解CPU的平均负载？





![top.png](images%2Ftop.png)





![uptime.png](images%2Fuptime.png)



## 1.1 平均活跃进程数

load average(平均负载)后面的三个数字分别表示CPU过去1分钟，5分钟，15分钟的平均负载。
简单来说，平均负载指的是单位时间内，系统处于可运行状态和不可中断状态的平均进程数，也就是平均活跃进程数，它和CPU使用率
并没有直接关系。


## 1.2 可运行状态和不可中断状态

所谓可运行状态的进程，指的是正在使用CPU的进程或者正在等待CPU的进程，也就是我们常用ps命令看到的，处于R状态(Running或Runnable)的进程。

不可中断状态的进程则是正处于内核态关键流程中的进程，并且这些流程是不可中断的，譬如最常见的就是等待硬件设备的I/O响应，也就是我们在ps命令
中看到的D状态(Uninterruptible Sleep, 也称为Disk Sleep)的进程。

比如，当一个进程向硬件设备读写数据时，为了保证数据的一致性，在得到磁盘回复前，它是不能被其他进程中断或者打断的，此时的进程就处于不可中断状态，
如果此时的进程被打断了，就容易出现磁盘数据与进程数据不一致的问题。

所以，不可中断状态实际上是系统对进程和硬件设备的一种保护机制。


## 1.3 平均负载为多少时合理？

既然平均负载指的是平均活跃进程数，那么最理想的，就是每个CPU上都刚好运行着一个进程，如此每个CPU都得到了充分利用。比如当平均负载为2时，意味着什么？
在只有2个CPU的系统上，意味着所有的CPU都刚好运行着一个进程，刚好被完全占用。
在4个CPU的系统上，意味着CPU有50%的空闲。
而在只有1个CPU的系统中，则意味着有一半的进程竞争不到CPU。

因此，评判平均负载情况时，首先你要知道系统有几个CPU，则可以通过top命令或从文件/proc/cpuinfo中读取，比如:

```shell
grep 'model name' /proc/cpuinfo | wc -l
```

有了CPU个数，我们就可以判断出，当平均负载比CPU数还大的时候，就意味着系统已经出现了过载。
那平均负载有三个数值，到底该参考哪一个呢？
总的来说，我们应该观察平均负载的变化趋势。
如果过去1分钟，5分钟，15分钟的三个值基本相同或者说相差不大，那就说明系统负载很平稳；如果1分钟的值远小于15分钟的值，
说明系统最近1分钟的负载在减少，而过去15分钟内确有很大的负载；反之，如果1分钟的值远大于15分钟的值，则说明系统最近1分钟
的负载在增加，这种增加有可能只是临时性的，也有可能还会持续增加下去，所以就需要持续观察，一旦1分钟的平均负载接近或
超过了CPU个数，就意味着系统正在发生过载的问题，此时就需要分析调查是哪里导致的问题，并要想办法优化了。

那么，在实际生产环境中，平均负载多高时，需要我们重点关注呢？
当平均负载高于CPU数量70%的时候，就应该分析排查负载高的问题了，一旦负载过高，就可能导致进程响应变慢，进而影响服务的正常功能。

# 2 平均负载与CPU使用率

平均负载高，并不意味着CPU使用率高，这两者不是一个概念，不能相互混淆。
我们知道，平均负载指的是单位时间内，处于可运行状态和不可中断状态的进程数，所以，它不仅包括了正在使用CPU的进程，还包括等待
CPU和等待I/O的进程。
而CPU使用率，是单位时间内CPU繁忙情况的表征，跟平均负载并不一定完全对应。比如:
CPU密集型进程，使用大量CPU会导致平均负载升高，此时这两者是一致的。

I/O密集型进程，等待I/O也会导致平均负载升高，但CPU使用率不一定很高。
大量等待CPU的进程调度也会导致平均负载升高，此时的CPU使用率也会比较高，因为这意味着CPU都被占满了，很繁忙，所以会有大量
进程等待被调度。

# 3 当平均负载高时，如何排查分析平均负载的来源？

我们可以使用mpstat，pidstat等工具，辅助分析负载的来源。





![mpstat.png](images%2Fmpstat.png)





-P ALL 表示监控所有CPU，后面数字5表示间隔5秒后输出一组数据。
如果你观察到某个CPU使用率为100%，你可以通过pidstat工具来查询具体是哪个进程导致了CPU使用率为100%
-u 表示cpu指标





![pidstat.png](images%2Fpidstat.png)