
---
如何迅速分析出系统CPU的瓶颈
---

# 1 CPU性能指标

> CPU使用率(usr,sys,wa)
> 平均负载(平均活跃进程数)
> 进程上下文切换(自愿上下文切换和非自愿上下文切换)
> CPU缓存命中率


# 2 根据指标找工具





![find-tools-base-on-indicator.png](images%2Ffind-tools-base-on-indicator.png)





# 3 根据工具查指标





![find-indicator-base-on-tools.png](images%2Ffind-indicator-base-on-tools.png)





# 4 整体思路

为了缩小排查范围，可以先运行几个支持指标较多的工具，如top、vmstat、pidstat。
这三个命令，几乎包含了所有重要的CPU性能指标，比如:
从top的输出可以得到各种CPU使用率以及僵尸进程和平均负载等信息。
从vmstat的输出可以得到上下文切换次数、中断次数、运行状态和不可中断状态的进程数。
从pidstat的输出可以得到进程的用户CPU使用率、系统CPU使用率、以及自愿上下文切换和非自愿上下文切换情况。

另外，这三个工具输出的很多指标是相互关联的。

比如，pidstat输出的进程用户CPU使用率升高，会导致top输出的用户CPU使用率升高。所以，当发现top输出的用户CPU使用率有问题时，可以跟pidstat的输出做对比，观察是否是某个进程导致的问题。
而找出导致性能问题的进程后，就要用进程分析工具来分析进程的行为，比如使用strace来分析系统调用情况，以及使用perf分析调用链中各级函数的执行情况。

又比如top输出的平均负载升高，可以跟vmstat输出的运行状态和不可中断状态的进程数做对比，观察是哪种进程导致的负载升高。
如果是不可中断进程数增多了，那么就需要做I/O分析，也就是用dstat和sar等工具，进一步分析I/O情况。
如果是运行状态进程数增多了，那就需要回到top和pidstat，找出这些处于运行状态的进程到底是什么进程，然后再使用进程分析工具，做进一步分析。

如果发现top输出的软中断CPU使用率升高时，可以查看/proc/softirqs 文件中各种类型软中断的变化情况，确定到底是哪种软中断出的问题。比如，
如果发现是网络接收中断导致的问题，接下来就可以使用网络工具sar和tcpdump来分析。


注意:
pidstat中，%wait 表示进程等待CPU的时间百分比，等待CPU的进程已经在CPU的就绪队列中，处于运行状态。
top中，iowait%  表示等待I/O 进程的CPU时间百分比，也就是不可中断进程的CPU利用率。