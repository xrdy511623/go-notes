
---
排查IP通信问题
---

# 1 问题的引出

让我们从一道面试题说起
服务器A的IP地址为192.168.26.129，子网掩码为255.255.255.0， 默认网关为192.168.26.2. 
而服务器B的IP地址为192.168.26.3，子网掩码为255.255.255.224， 默认网关为192.168.26.2, 
请问A和B能进行网络通信吗？为什么？

子网掩码的作用是将一个 IP 地址分成两个部分：网络部分和主机部分。子网掩码使用二进制的方式表示，它的位数决定了网络部分的长度。
什么是子网掩码？
子网掩码是一组 32 位的数字，用来划分 IP 地址的网络部分和主机部分。子网掩码的规则是：

子网掩码中 1 的部分代表网络部分。
子网掩码中 0 的部分代表主机部分。
IP 地址本身也是 32 位的数字，通常分成 4 组，每组 8 位（即 1 字节），使用点分十进制表示（例如 192.168.26.129）。
子网掩码和 IP 地址一样，也是点分十进制表示的 32 位数字。

所以服务器A的子网掩码255.255.255.0，转换为二进制就是11111111.11111111.11111111.00000000，可以看到，前24位都是
1，表示网络部分，后面8位都是0，表示主机部分。
也就是说，服务器A的网络部分的长度是 24 位，最后的 8 位是主机位。

服务器 A 的 IP 是 192.168.26.129，因此它的网络号可以通过按位与计算得到：

````shell
IP 地址 A:       192.168.26.129 -> 11000000.10101000.00011010.10000001
子网掩码 A:       255.255.255.0  -> 11111111.11111111.11111111.00000000
---------------------------------------------------------------
网络地址 A:        192.168.26.0   -> 11000000.10101000.00011010.00000000
````

因此服务器A的子网范围就是192.168.26.0~192.168.26.255(最后8位是主机号，即子网范围，也就是00000000到11111111，
转化为十进制就是0-255)


同理，服务器B的子网掩码255.255.255.224，转换为二进制就是11111111.11111111.11111111.11100000，可以看到，前27位都是
1，表示网络部分，后面5位都是0，表示主机部分。
也就是说，服务器B的网络部分的长度是 27 位，最后的 5 位是主机位。

服务器 B 的 IP 是 192.168.26.3，因此它的网络号可以通过按位与计算得到：

```shell
IP 地址 B:       192.168.26.3   -> 11000000.10101000.00011010.00000011
子网掩码 B:       255.255.255.224 -> 11111111.11111111.11111111.11100000
---------------------------------------------------------------
网络地址 B:       192.168.26.0   -> 11000000.10101000.00011010.00000000
```

因此服务器B的子网范围就是192.168.26.0~192.168.26.31(最后5位是主机号，即子网范围，也就是00000000到00011111，
转化为十进制就是0-31)

比较子网范围
服务器 A 的子网范围是 192.168.26.0 - 192.168.26.255。
服务器 B 的子网范围是 192.168.26.0 - 192.168.26.31。
由于服务器 B 的子网范围包含在服务器 A 的子网范围内，因此 从 IP 地址和子网的角度来看，A 和 B 在同一个子网范围内，
可以直接通信。

网络通信的判断
由于服务器 A 和服务器 B 在同一子网内(网络地址都是192.168.26.0，属于同一子网)，它们可以直接进行通信。即使服务器 B 的
子网范围较小（/27），但它的 IP 地址仍然在服务器 A 的子网范围（/24）中，因此网络通信不受阻碍。

默认网关的影响
两台服务器的默认网关都是 192.168.26.2。只要两台服务器在同一子网中，它们的通信不需要经过网关。默认网关主要用于发送超出
本地网络的流量。由于 A 和 B 在同一个子网范围内，因此它们的通信不需要通过网关，能够直接通信。

结论
服务器 A 和服务器 B 可以进行网络通信，因为它们的 IP 地址都在同一个子网（192.168.26.0/27）中，不需要借助网关来实现通信。

当然，这里说服务器 A 和服务器 B 可以直接进行网络通信，不需要网关转发，指的是A去ping B的情况，如果是反过来，那么B是不能和
A直接通信的，需要通过网关转发才能ping通A的。

服务器 A 视角
服务器 A 的子网掩码是 255.255.255.0，也就是 /24，表示网络部分是 192.168.26.0，网络范围是从 192.168.26.1 到 
192.168.26.254（不包括广播地址和网络地址）。因此在 A 看来，192.168.26.3 是同一网络的 IP 地址，因为它落在 A 
的子网范围内。

A 去 ping B：
A 通过它的子网掩码会判断 B（192.168.26.3）和自己在同一个子网中，不需要经过网关转发，直接通过 ARP 获取 B 的 MAC 地址，
然后直接通信。

服务器 B 视角
服务器 B 的子网掩码是 255.255.255.224，即 /27，它的子网范围是 192.168.26.0 到 192.168.26.31。这意味着 B 可以
直接通信的主机范围是 192.168.26.1 到 192.168.26.31，而 A 的 IP 地址 192.168.26.129 超出了 B 的子网范围。

B 去 ping A：
B 根据自己的子网掩码判断，A（192.168.26.129）不在同一子网内，因此 B 会尝试通过网关通信。首先，B 会发出 ARP 广播请求，
获取默认网关（192.168.26.2）的 MAC 地址，然后通过网关转发请求到达 A。

再来看下一道题
服务器A的ip地址是192.168.182.131，子网掩码是255.255.255.0，默认网关为192.168.26.2.
服务器B的ip地址是192.168.176.0， 子网掩码是255.255.248.0， 默认网关是192.168.26.2， 
请问B能直接ping 通A吗？是否需要网关转发才能通信？为什么？

服务器A的子网掩码255.255.255.0，转换为二进制就是11111111.11111111.11111111.00000000，可以看到，前24位都是
1，表示网络部分，后面8位都是0，表示主机部分。
也就是说，服务器A的网络部分的长度是 24 位，最后的 8 位是主机位。

服务器 A 的 IP 是 192.168.182.131，因此它的网络号可以通过按位与计算得到：

````shell
IP 地址 A:       192.168.182.131 -> 11000000.10101000.10110110.10000011
子网掩码 A:       255.255.255.0  -> 11111111.11111111.11111111.00000000
---------------------------------------------------------------
网络地址 A:        192.168.182.0   -> 11000000.10101000.10110110.00000000
````

因此服务器A的子网范围就是192.168.182.0~192.168.182.255(最后8位是主机号，即子网范围，也就是00000000到11111111，
转化为十进制就是0-255)


服务器B的子网掩码255.255.248.0，转换为二进制就是11111111.11111111.11111000.00000000，可以看到，前21位都是
1，表示网络部分，后面11位都是0，表示主机部分。
也就是说，服务器B的网络部分的长度是 21 位，最后的 11 位是主机位。

服务器 B 的 IP 是 192.168.176.0，因此它的网络号可以通过按位与计算得到：

````shell
IP 地址 B:       192.168.176.0 -> 11000000.10101000.10110000.00000000
子网掩码 B:       255.255.248.0  -> 11111111.11111111.11111000.00000000
---------------------------------------------------------------
网络地址 B:        192.168.176.0   -> 11000000.10101000.10110000.00000000
````

计算广播地址：
要计算广播地址，我们将主机位的 11 位全置为 1，得到广播地址：
11000000.10101000.10110111.11111111
转换为十进制，就是192.168.183.255

所以广播地址为 192.168.183.255。
确定网络范围
网络地址：192.168.176.0
广播地址：192.168.183.255
因此，这个 /21 网络的 IP 地址范围是从 192.168.176.0 到 192.168.183.255。

能否直接通信
根据服务器 B 的子网掩码 /21 的计算，它的网络范围包括了 192.168.182.131 这个 IP 地址。因此，B 能够认为 A 是同一个
子网的设备，不需要通过网关转发流量。
对于服务器 A，由于其子网掩码是 /24，它只能看到自己所在的 192.168.182.0/24 网段中的地址。服务器 B 的 IP 地址是
192.168.176.0，在 A 的视角中，B 是位于不同的网段的设备，A 认为它不在自己的子网中。

是否需要网关转发
A 无法直接 ping B：A 认为 B 不在同一个子网，因此 A 发起的通信会通过默认网关进行转发。
B 能直接 ping A：B 的子网掩码范围包含了 A，所以 B 会直接尝试通信，不经过网关。

结论
B ping A 可以直接通信，不需要经过网关。
A ping B 无法直接通信，需要经过网关转发。