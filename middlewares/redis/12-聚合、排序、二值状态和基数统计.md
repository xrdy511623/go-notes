
---
聚合、排序、二值状态和基数统计
---


# 1 背景

在Web和移动应⽤的业务场景中，我们经常需要保存这样⼀种信息：⼀个key对应了⼀个数据集合。举⼏个例⼦。

⼿机App中的每天的⽤⼾登录信息：⼀天对应⼀系列⽤⼾ID或移动设备ID；
电商⽹站上商品的⽤⼾评论列表：⼀个商品对应了⼀系列的评论；
⽤⼾在⼿机App上的签到打卡信息：⼀天对应⼀系列⽤⼾的签到记录；
应⽤⽹站上的⽹⻚访问信息：⼀个⽹⻚对应⼀系列的访问点击。

我们知道，Redis集合类型的特点就是⼀个键对应⼀系列的数据，所以⾮常适合⽤来存取这些数据。但是，
在这些场景中，除了记录信息，我们往往还需要对集合中的数据进⾏统计，例如：

在移动应⽤中，需要统计每天的新增⽤⼾数和第⼆天的留存⽤⼾数；
在电商⽹站的商品评论中，需要统计评论列表中的最新评论；
在签到打卡中，需要统计⼀个⽉内连续打卡的⽤⼾数；
在⽹⻚访问记录中，需要统计独⽴访客（Unique Visitor，UV）量。

通常情况下，我们⾯临的⽤⼾数量以及访问量都是巨⼤的，⽐如百万、千万级别的⽤⼾数量，或者千万级
别、甚⾄亿级别的访问信息。所以，我们必须要选择能够⾮常⾼效地统计⼤量数据（例如亿级）的集合类型。

要想选择合适的集合，我们就得了解常⽤的集合统计模式。这节课，我就给你介绍集合类型常⻅的四种统计
模式，包括聚合统计、排序统计、⼆值状态统计和基数统计。我会以刚刚提到的这四个场景为例，和你聊聊
在这些统计模式下，什么集合类型能够更快速地完成统计，⽽且还节省内存空间。掌握了今天的内容，之后
再遇到集合元素统计问题时，你就能很快地选出合适的集合类型了。


# 2 聚合统计

我们先来看集合元素统计的第⼀个场景：聚合统计。

所谓的聚合统计，就是指统计多个集合元素的聚合结果，包括：统计多个集合的共有元素（交集统计）；把
两个集合相⽐，统计其中⼀个集合独有的元素（差集统计）；统计多个集合的所有元素（并集统计）。

在刚才提到的场景中，统计⼿机App每天的新增⽤⼾数和第⼆天的留存⽤⼾数，正好对应了聚合统计。

要完成这个统计任务，我们可以⽤⼀个集合记录所有登录过App的⽤⼾ID，同时，⽤另⼀个集合记录每⼀天
登录过App的⽤⼾ID。然后，再对这两个集合做聚合统计。我们来看下具体的操作。

记录所有登录过App的⽤⼾ID还是⽐较简单的，我们可以直接使⽤Set类型，把key设置为user:id，表
⽰记录的是⽤⼾ID，value就是⼀个Set集合，⾥⾯是所有登录过App的⽤⼾ID，我们可以把这个Set叫作累
计⽤⼾Set。

需要注意的是，累计⽤⼾Set中没有⽇期信息，我们是不能直接统计每天的新增⽤⼾的。所以，我们还需要
把每⼀天登录的⽤⼾ID，记录到⼀个新集合中，我们把这个集合叫作每⽇⽤⼾Set，它有两个特点：

1. key是user:id以及当天⽇期，例如user:id:20200803；
2. value是Set集合，记录当天登录的⽤⼾ID。






![aggregation-demo.png](images%2Faggregation-demo.png)





在统计每天的新增⽤⼾时，我们只⽤计算每⽇⽤⼾Set和累计⽤⼾Set的差集就⾏。

下面借⼀个具体的例⼦来解释⼀下。

假设我们的⼿机App在2020年8⽉3⽇上线，那么，8⽉3⽇前是没有⽤⼾的。此时，累计⽤⼾Set是空集，当
天登录的⽤⼾ID会被记录到 key为user:id:20200803的Set中。所以，user:id:20200803这个Set中
的⽤⼾就是当天的新增⽤⼾。

然后，我们计算累计⽤⼾Set和user:id:20200803 Set的并集结果，结果保存在user:id这个累计⽤
⼾Set中，如下所⽰：

```shell
SUNIONSTORE user:id user:id user:id:20200803
```

此时，user:id这个累计⽤⼾Set中就有了8⽉3⽇的⽤⼾ID。等到8⽉4⽇再统计时，我们把8⽉4⽇登录的
⽤⼾ID记录到user:id:20200804 的Set中。接下来，我们执⾏SDIFFSTORE命令计算累计⽤⼾Set和
user:id:20200804 Set的差集，结果保存在key为user:new的Set中，如下所⽰：

```shell
SDIFFSTORE user:new user:id:20200804 user:id
```

可以看到，这个差集中的⽤⼾ID在user:id:20200804 的Set中存在，但是不在累计⽤⼾Set中。所以，
user:new这个Set中记录的就是8⽉4⽇的新增⽤⼾。

当要计算8⽉4⽇的留存⽤⼾时，我们只需要再计算user:id:20200803 和 user:id:20200804两个Set
的交集，就可以得到同时在这两个集合中的⽤⼾ID了，这些就是在8⽉3⽇登录，并且在8⽉4⽇留存的⽤
⼾。执⾏的命令如下：

```shell
SINTERSTORE user:id:remain user:id:20200803 user:id:20200804
```

当你需要对多个集合进⾏聚合计算时，Set类型会是⼀个⾮常不错的选择。不过，我要提醒你⼀下，这⾥有
⼀个潜在的⻛险。

Set的差集、并集和交集的计算复杂度较⾼，在数据量较⼤的情况下，如果直接执⾏这些计算，会导致Redis
实例阻塞。所以，我给你分享⼀个⼩建议：你可以从主从集群中选择⼀个从库，让它专⻔负责聚合计算，或
者是把数据读取到客⼾端，在客⼾端来完成聚合统计，这样就可以规避阻塞主库实例和其他从库实例的⻛险了。


# 3 排序统计
